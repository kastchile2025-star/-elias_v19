<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificaci√≥n Estudiantes Espec√≠ficos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a84; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Verificaci√≥n: Estudiantes Espec√≠ficos en Tareas</h1>
        
        <div id="status"></div>
        
        <div>
            <button onclick="ejecutarDiagnostico()">üîç Diagnosticar Problema</button>
            <button onclick="crearDatosPrueba()">üöÄ Crear Datos de Prueba</button>
            <button onclick="verificarLocalStorage()">üìä Verificar Datos</button>
            <button onclick="irATareas()">üìù Ir a Crear Tarea</button>
        </div>
        
        <div id="resultados" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultados = document.getElementById('resultados');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            resultados.innerHTML += `<div class="${className}">${message}</div>`;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('resultados').innerHTML = '';
        }

        function verificarLocalStorage() {
            clearLog();
            log('üìä VERIFICANDO DATOS EN LOCALSTORAGE...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
                const sections = JSON.parse(localStorage.getItem('smart-student-sections') || '[]');
                const teacherAssignments = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
                
                log(`‚úÖ Usuario actual: ${auth.user?.displayName || 'No logueado'} (${auth.user?.role || 'N/A'})`, 'success');
                log(`üìä Total usuarios: ${users.length}`, 'info');
                log(`üìä Total cursos: ${courses.length}`, 'info');
                log(`üìä Total secciones: ${sections.length}`, 'info');
                log(`üìä Total asignaciones: ${teacherAssignments.length}`, 'info');
                
                if (auth.user?.role === 'teacher') {
                    const estudiantesAsignados = users.filter(u => 
                        u.role === 'student' && (
                            u.assignedTeacher === auth.user.username ||
                            (u.assignedTeachers && Object.values(u.assignedTeachers).includes(auth.user.username))
                        )
                    );
                    log(`üë• Estudiantes asignados al profesor: ${estudiantesAsignados.length}`, estudiantesAsignados.length > 0 ? 'success' : 'warning');
                    estudiantesAsignados.forEach(s => {
                        log(`   ‚Ä¢ ${s.displayName} - Curso: ${s.activeCourses?.[0] || 'Sin curso'}`, 'info');
                    });
                } else {
                    log('‚ö†Ô∏è No est√°s logueado como profesor', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Error verificando datos: ${error.message}`, 'error');
            }
        }

        function ejecutarDiagnostico() {
            clearLog();
            log('üîç EJECUTANDO DIAGN√ìSTICO...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                const courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
                const teacherAssignments = JSON.parse(localStorage.getItem('smart-student-teacher-assignments') || '[]');
                
                const currentUser = auth.user;
                
                if (!currentUser || currentUser.role !== 'teacher') {
                    log('‚ùå Error: Necesitas estar logueado como profesor', 'error');
                    log('üí° Acci√≥n: Ve a http://localhost:9002 y haz login como profesor', 'warning');
                    return;
                }
                
                log(`‚úÖ Profesor logueado: ${currentUser.displayName}`, 'success');
                
                // Verificar estudiantes asignados
                const estudiantesAsignados = users.filter(u => 
                    u.role === 'student' && (
                        u.assignedTeacher === currentUser.username ||
                        (u.assignedTeachers && Object.values(u.assignedTeachers).includes(currentUser.username))
                    )
                );
                
                log(`üéì Estudiantes asignados: ${estudiantesAsignados.length}`, estudiantesAsignados.length > 0 ? 'success' : 'error');
                
                if (estudiantesAsignados.length === 0) {
                    log('‚ùå PROBLEMA ENCONTRADO: No hay estudiantes asignados al profesor', 'error');
                    log('üí° SOLUCI√ìN: Hacer clic en "Crear Datos de Prueba"', 'warning');
                    return;
                }
                
                // Verificar cursos disponibles
                const cursosDelProfesor = [...new Set(estudiantesAsignados.flatMap(s => s.activeCourses || []))];
                log(`üìö Cursos con estudiantes: ${cursosDelProfesor.join(', ')}`, 'success');
                
                // Verificar por cada curso
                cursosDelProfesor.forEach(curso => {
                    const estudiantesEnCurso = estudiantesAsignados.filter(s => s.activeCourses?.includes(curso));
                    log(`   üìñ ${curso}: ${estudiantesEnCurso.length} estudiantes`, 'info');
                    estudiantesEnCurso.forEach(s => {
                        log(`     ‚Ä¢ ${s.displayName}`, 'info');
                    });
                });
                
                log('‚úÖ DIAGN√ìSTICO COMPLETADO: La funcionalidad deber√≠a estar operativa', 'success');
                log('üí° Si a√∫n no ves estudiantes, prueba recargar la p√°gina de tareas', 'warning');
                
            } catch (error) {
                log(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
            }
        }

        function crearDatosPrueba() {
            clearLog();
            log('üöÄ CREANDO DATOS DE PRUEBA...', 'info');
            
            try {
                const auth = JSON.parse(localStorage.getItem('smart-student-auth') || '{}');
                const currentUser = auth.user;
                
                if (!currentUser || currentUser.role !== 'teacher') {
                    log('‚ùå Error: Necesitas estar logueado como profesor', 'error');
                    return;
                }
                
                const users = JSON.parse(localStorage.getItem('smart-student-users') || '[]');
                
                // Crear estudiantes de prueba
                const estudiantesPrueba = [
                    { username: 'ana.test', name: 'Ana Test' },
                    { username: 'luis.test', name: 'Luis Test' },
                    { username: 'sofia.test', name: 'Sofia Test' },
                    { username: 'maria.test', name: 'Maria Test' }
                ];
                
                let creados = 0;
                let actualizados = 0;
                
                estudiantesPrueba.forEach(({ username, name }) => {
                    const existingStudent = users.find(u => u.username === username);
                    
                    const studentData = {
                        id: existingStudent?.id || `student-${username}`,
                        username: username,
                        displayName: name,
                        role: 'student',
                        activeCourses: ['4to B√°sico'],
                        assignedTeacher: currentUser.username,
                        assignedTeachers: {
                            'Matem√°ticas': currentUser.username,
                            'Lenguaje y Comunicaci√≥n': currentUser.username,
                            'Ciencias Naturales': currentUser.username,
                            'Historia, Geograf√≠a y Ciencias Sociales': currentUser.username
                        }
                    };
                    
                    if (existingStudent) {
                        Object.assign(existingStudent, studentData);
                        actualizados++;
                        log(`‚úÖ Actualizado: ${name}`, 'success');
                    } else {
                        users.push(studentData);
                        creados++;
                        log(`‚úÖ Creado: ${name}`, 'success');
                    }
                });
                
                // Crear curso b√°sico si no existe
                let courses = JSON.parse(localStorage.getItem('smart-student-courses') || '[]');
                if (!courses.find(c => c.id === '4to B√°sico')) {
                    courses.push({ id: '4to B√°sico', name: '4to B√°sico' });
                    localStorage.setItem('smart-student-courses', JSON.stringify(courses));
                    log('‚úÖ Creado curso: 4to B√°sico', 'success');
                }
                
                // Guardar usuarios
                localStorage.setItem('smart-student-users', JSON.stringify(users));
                
                log(`üéâ PROCESO COMPLETADO:`, 'success');
                log(`   ‚Ä¢ Estudiantes creados: ${creados}`, 'success');
                log(`   ‚Ä¢ Estudiantes actualizados: ${actualizados}`, 'success');
                log(`   ‚Ä¢ Todos asignados al profesor: ${currentUser.displayName}`, 'success');
                log('üí° Ahora ve a Crear Tarea y selecciona "Estudiantes espec√≠ficos"', 'warning');
                
            } catch (error) {
                log(`‚ùå Error creando datos: ${error.message}`, 'error');
            }
        }

        function irATareas() {
            window.open('http://localhost:9002/dashboard/tareas', '_blank');
        }

        // Ejecutar verificaci√≥n inicial
        window.onload = function() {
            verificarLocalStorage();
        };
    </script>
</body>
</html>
