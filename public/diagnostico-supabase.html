<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiagnÃ³stico Supabase - Borrado de Registros</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background-color: #005a9e;
        }
        .button.danger {
            background-color: #dc3545;
        }
        .button.danger:hover {
            background-color: #c82333;
        }
        .button.warning {
            background-color: #ffc107;
            color: #000;
        }
        .button.warning:hover {
            background-color: #e0a800;
        }
        .log-area {
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info-box {
            background-color: #e7f3ff;
            border: 1px solid #007acc;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” DiagnÃ³stico de Borrado Supabase</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ Instrucciones:</h3>
            <p>1. Abre las <strong>Herramientas de Desarrollador</strong> (F12)</p>
            <p>2. Ve a la pestaÃ±a <strong>Consola</strong></p>
            <p>3. Usa los botones de abajo para ejecutar diagnÃ³sticos</p>
            <p>4. Observa los logs detallados en la consola del navegador</p>
        </div>

        <div class="grid">
            <div class="section">
                <h3>ğŸš€ DiagnÃ³sticos Principales</h3>
                <button class="button" onclick="ejecutarDiagnosticoCompleto()">
                    ğŸ” DiagnÃ³stico Completo
                </button>
                <button class="button" onclick="verificacionRapida()">
                    âš¡ VerificaciÃ³n RÃ¡pida
                </button>
                <button class="button warning" onclick="verificarConexion()">
                    ğŸ“¡ Verificar ConexiÃ³n SQL
                </button>
            </div>

            <div class="section">
                <h3>ğŸ“Š Verificaciones de Datos</h3>
                <button class="button" onclick="contarRegistros()">
                    ğŸ“ˆ Contar Registros (2025)
                </button>
                <button class="button" onclick="consultaDirecta()">
                    ğŸ” Consulta Directa Supabase
                </button>
                <button class="button" onclick="verificarAno(2024)">
                    ğŸ“… Verificar AÃ±o 2024
                </button>
            </div>
        </div>

        <div class="section">
            <h3>ğŸ—‘ï¸ Operaciones de Borrado (Â¡CUIDADO!)</h3>
            <button class="button danger" onclick="ejecutarBorrado2025()">
                ğŸ—‘ï¸ Borrar Registros 2025
            </button>
            <button class="button danger" onclick="ejecutarBorrado2024()">
                ğŸ—‘ï¸ Borrar Registros 2024
            </button>
            <p><strong>âš ï¸ Advertencia:</strong> Estas operaciones eliminan datos permanentemente</p>
        </div>

        <div class="section">
            <h3>ğŸ“‹ Estado Actual</h3>
            <div id="estadoActual" class="status">
                â³ Esperando diagnÃ³stico...
            </div>
        </div>

        <div class="section">
            <h3>ğŸ“ Log de Actividades</h3>
            <div id="logArea" class="log-area">
ğŸ” DIAGNÃ“STICO DE BORRADO SUPABASE CARGADO
===========================================

ğŸ’¡ Uso recomendado:
1. Ejecutar "DiagnÃ³stico Completo" primero
2. Observar logs en la consola del navegador (F12)
3. Identificar discrepancias entre conteos
4. Usar "Consulta Directa" para verificar estado real

ğŸ“Œ Todos los logs detallados aparecerÃ¡n en la consola del navegador.
            </div>
        </div>
    </div>

    <script>
        // FunciÃ³n para agregar logs al Ã¡rea visual
        function addLog(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // FunciÃ³n para actualizar estado
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('estadoActual');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Cargar el script de diagnÃ³stico
        async function cargarDiagnostico() {
            try {
                // Ejecutar el script de diagnÃ³stico
                const response = await fetch('/DIAGNOSTICO-SUPABASE-BORRADO.js');
                const script = await response.text();
                eval(script);
                addLog('âœ… Script de diagnÃ³stico cargado exitosamente');
                updateStatus('âœ… DiagnÃ³stico cargado y listo', 'success');
            } catch (error) {
                addLog(`âŒ Error cargando diagnÃ³stico: ${error.message}`);
                updateStatus('âŒ Error cargando diagnÃ³stico', 'error');
                console.error('Error cargando diagnÃ³stico:', error);
            }
        }

        // DiagnÃ³sticos principales
        async function ejecutarDiagnosticoCompleto() {
            addLog('ğŸš€ Ejecutando diagnÃ³stico completo...');
            updateStatus('ğŸ” Ejecutando diagnÃ³stico completo...', 'warning');
            try {
                const resultado = await diagnosticoSupabase.completo(2025);
                addLog('âœ… DiagnÃ³stico completo finalizado - Ver consola para detalles');
                updateStatus('âœ… DiagnÃ³stico completo finalizado', 'success');
                console.log('ğŸ¯ RESULTADO FINAL DEL DIAGNÃ“STICO:', resultado);
            } catch (error) {
                addLog(`âŒ Error en diagnÃ³stico completo: ${error.message}`);
                updateStatus('âŒ Error en diagnÃ³stico', 'error');
                console.error('Error:', error);
            }
        }

        async function verificacionRapida() {
            addLog('âš¡ Ejecutando verificaciÃ³n rÃ¡pida...');
            updateStatus('âš¡ VerificaciÃ³n rÃ¡pida en curso...', 'warning');
            try {
                const resultado = await diagnosticoSupabase.rapido(2025);
                addLog(`ğŸ“Š Registros encontrados: ${resultado?.directCount || 0}`);
                updateStatus(`ğŸ“Š Registros actuales: ${resultado?.directCount || 0}`, 'success');
            } catch (error) {
                addLog(`âŒ Error en verificaciÃ³n rÃ¡pida: ${error.message}`);
                updateStatus('âŒ Error en verificaciÃ³n', 'error');
            }
        }

        async function verificarConexion() {
            addLog('ğŸ“¡ Verificando conexiÃ³n SQL...');
            updateStatus('ğŸ“¡ Verificando conexiÃ³n...', 'warning');
            try {
                const sqlDatabase = await diagnosticoSupabase.verificarConexion();
                if (sqlDatabase) {
                    addLog('âœ… ConexiÃ³n SQL exitosa');
                    updateStatus('âœ… SQL conectado', 'success');
                } else {
                    addLog('âŒ FallÃ³ la conexiÃ³n SQL');
                    updateStatus('âŒ SQL desconectado', 'error');
                }
            } catch (error) {
                addLog(`âŒ Error verificando conexiÃ³n: ${error.message}`);
                updateStatus('âŒ Error de conexiÃ³n', 'error');
            }
        }

        // Verificaciones especÃ­ficas
        async function contarRegistros() {
            addLog('ğŸ“ˆ Contando registros...');
            try {
                const sqlDatabase = await diagnosticoSupabase.verificarConexion();
                const resultado = await diagnosticoSupabase.contarAntes(sqlDatabase, 2025);
                addLog(`ğŸ“Š Registros 2025: ${resultado?.countByYear?.count || 0}`);
                addLog(`ğŸ“Š Total registros: ${resultado?.countAll?.total || 0}`);
            } catch (error) {
                addLog(`âŒ Error contando: ${error.message}`);
            }
        }

        async function consultaDirecta() {
            addLog('ğŸ” Ejecutando consulta directa...');
            try {
                const resultado = await diagnosticoSupabase.consultaDirecta(2025);
                addLog(`ğŸ“Š Consulta directa - Registros: ${resultado?.directCount || 0}`);
                addLog(`ğŸ“Š Total directo: ${resultado?.totalDirectCount || 0}`);
            } catch (error) {
                addLog(`âŒ Error en consulta directa: ${error.message}`);
            }
        }

        async function verificarAno(ano) {
            addLog(`ğŸ“… Verificando aÃ±o ${ano}...`);
            try {
                const resultado = await diagnosticoSupabase.consultaDirecta(ano);
                addLog(`ğŸ“Š Registros aÃ±o ${ano}: ${resultado?.directCount || 0}`);
            } catch (error) {
                addLog(`âŒ Error verificando aÃ±o ${ano}: ${error.message}`);
            }
        }

        // Operaciones de borrado
        async function ejecutarBorrado2025() {
            if (!confirm('âš ï¸ Â¿EstÃ¡s seguro de que quieres BORRAR todos los registros del aÃ±o 2025? Esta acciÃ³n es IRREVERSIBLE.')) {
                return;
            }
            addLog('ğŸ—‘ï¸ EJECUTANDO BORRADO 2025...');
            updateStatus('ğŸ—‘ï¸ Borrando registros 2025...', 'warning');
            try {
                const sqlDatabase = await diagnosticoSupabase.verificarConexion();
                const resultado = await diagnosticoSupabase.ejecutarBorrado(sqlDatabase, 2025);
                addLog(`âœ… Borrado completado - Eliminados: ${resultado?.deleted || 0}`);
                updateStatus(`ğŸ—‘ï¸ Borrado completado: ${resultado?.deleted || 0} registros`, 'success');
            } catch (error) {
                addLog(`âŒ Error en borrado: ${error.message}`);
                updateStatus('âŒ Error en borrado', 'error');
            }
        }

        async function ejecutarBorrado2024() {
            if (!confirm('âš ï¸ Â¿EstÃ¡s seguro de que quieres BORRAR todos los registros del aÃ±o 2024? Esta acciÃ³n es IRREVERSIBLE.')) {
                return;
            }
            addLog('ğŸ—‘ï¸ EJECUTANDO BORRADO 2024...');
            updateStatus('ğŸ—‘ï¸ Borrando registros 2024...', 'warning');
            try {
                const sqlDatabase = await diagnosticoSupabase.verificarConexion();
                const resultado = await diagnosticoSupabase.ejecutarBorrado(sqlDatabase, 2024);
                addLog(`âœ… Borrado completado - Eliminados: ${resultado?.deleted || 0}`);
                updateStatus(`ğŸ—‘ï¸ Borrado completado: ${resultado?.deleted || 0} registros`, 'success');
            } catch (error) {
                addLog(`âŒ Error en borrado: ${error.message}`);
                updateStatus('âŒ Error en borrado', 'error');
            }
        }

        // Cargar diagnÃ³stico al cargar la pÃ¡gina
        window.addEventListener('load', cargarDiagnostico);
    </script>
</body>
</html>