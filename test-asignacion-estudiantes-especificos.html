<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ PRUEBA: Asignaci√≥n de Tareas a Estudiantes Espec√≠ficos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f6fa;
            color: #2c3e50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .success { border-color: #27ae60; background-color: #d5f4e6; }
        .error { border-color: #e74c3c; background-color: #fadbd8; }
        .warning { border-color: #f39c12; background-color: #fef5e7; }
        .info { border-color: #3498db; background-color: #ebf3fd; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .step-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .check-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .result-box {
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .notification-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .notification-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .notification-details {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin: 2px;
        }
        
        .student-specific { background-color: #e8f5e8; border-left: 4px solid #27ae60; }
        .course-wide { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .comparison-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ PRUEBA: Asignaci√≥n de Tareas a Estudiantes Espec√≠ficos</h1>
            <p>Verificaci√≥n de notificaciones para tareas asignadas a estudiantes particulares</p>
        </div>

        <div class="test-section info">
            <h3>üìã Informaci√≥n del Problema</h3>
            <p><strong>Problema identificado:</strong> Cuando el profesor asigna una tarea a un estudiante espec√≠fico, la notificaci√≥n no aparece en la campana de notificaciones del estudiante.</p>
            <p><strong>Causa:</strong> La funci√≥n <code>createNewTaskNotifications</code> no consideraba las asignaciones espec√≠ficas (<code>assignedTo: 'student'</code> y <code>assignedStudentIds</code>).</p>
            <p><strong>Soluci√≥n:</strong> Modificar la funci√≥n para que filtre solo los estudiantes espec√≠ficos cuando sea una asignaci√≥n dirigida.</p>
        </div>

        <div class="test-section">
            <h3>üîß Pasos de Prueba</h3>
            
            <button onclick="paso1_ConfigurarDatos()" class="step-button">
                Paso 1: Configurar Datos de Prueba
            </button>
            <div id="resultado-paso1" class="result-box"></div>

            <button onclick="paso2_CrearTareaEspecifica()" class="step-button">
                Paso 2: Crear Tarea para Estudiante Espec√≠fico
            </button>
            <div id="resultado-paso2" class="result-box"></div>

            <button onclick="paso3_CrearTareaCurso()" class="step-button">
                Paso 3: Crear Tarea para Todo el Curso (Comparaci√≥n)
            </button>
            <div id="resultado-paso3" class="result-box"></div>

            <button onclick="verificarNotificaciones()" class="check-button">
                üîç Verificar Notificaciones Generadas
            </button>
            <div id="resultado-verificacion" class="result-box"></div>
        </div>

        <div class="test-section">
            <h3>üìä Resultados de la Verificaci√≥n</h3>
            <div id="panel-resultados"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Panel de Notificaciones Simulado</h3>
            <div id="simulacion-panel"></div>
        </div>
    </div>

    <script>
        // Datos de prueba
        const datosPrueba = {
            profesor: {
                id: 'prof_001',
                username: 'prof_ciencias',
                displayName: 'Prof. Garc√≠a',
                role: 'teacher'
            },
            estudiantes: [
                { id: 'est_001', username: 'felipe_est', displayName: 'Felipe Estudiante', role: 'student', activeCourses: ['ciencias_5to'] },
                { id: 'est_002', username: 'maria_est', displayName: 'Mar√≠a Gonz√°lez', role: 'student', activeCourses: ['ciencias_5to'] },
                { id: 'est_003', username: 'carlos_est', displayName: 'Carlos Rodr√≠guez', role: 'student', activeCourses: ['ciencias_5to'] },
                { id: 'est_004', username: 'ana_est', displayName: 'Ana L√≥pez', role: 'student', activeCourses: ['ciencias_5to'] }
            ],
            curso: 'ciencias_5to'
        };

        // Sistema de notificaciones simulado
        const NotificationSystem = {
            getNotifications() {
                return JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            },

            saveNotifications(notifications) {
                localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
            },

            getTasks() {
                return JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            },

            saveTasks(tasks) {
                localStorage.setItem('smart-student-tasks', JSON.stringify(tasks));
            },

            getUsers() {
                return JSON.parse(localStorage.getItem('smart-student-users') || '[]');
            },

            saveUsers(users) {
                localStorage.setItem('smart-student-users', JSON.stringify(users));
            },

            // Implementaci√≥n de createNewTaskNotifications corregida
            createNewTaskNotifications(taskId, taskTitle, course, subject, teacherUsername, teacherDisplayName, taskType = 'assignment') {
                console.log('=== DEBUG createNewTaskNotifications ===');
                console.log('TaskId:', taskId);
                console.log('Course:', course);
                
                // üîß CORRECCI√ìN: Obtener la tarea para verificar asignaciones espec√≠ficas
                const tasks = this.getTasks();
                const currentTask = tasks.find(task => task.id === taskId);
                
                let targetStudents = [];
                
                if (currentTask && currentTask.assignedTo === 'student' && currentTask.assignedStudentIds) {
                    // üéØ Tarea asignada a estudiantes espec√≠ficos
                    console.log('üìã Tarea asignada a estudiantes espec√≠ficos:', currentTask.assignedStudentIds);
                    
                    // Obtener datos de usuarios para convertir IDs a usernames
                    const users = this.getUsers();
                    
                    targetStudents = currentTask.assignedStudentIds
                        .map(studentId => {
                            const user = users.find(u => u.id === studentId);
                            if (user && user.role === 'student') {
                                return {
                                    username: user.username,
                                    displayName: user.displayName || user.username
                                };
                            }
                            return null;
                        })
                        .filter(student => student !== null);
                    
                    console.log('üéØ Estudiantes espec√≠ficos encontrados:', targetStudents);
                } else {
                    // üìö Tarea asignada a todo el curso
                    console.log('üìö Tarea asignada a todo el curso');
                    targetStudents = this.getStudentsInCourse(course);
                    console.log('Students found in course:', targetStudents);
                }
                
                if (targetStudents.length === 0) {
                    console.log('No target students found, skipping notification creation');
                    return;
                }

                const notifications = this.getNotifications();
                console.log('Current notifications count:', notifications.length);
                
                const newNotification = {
                    id: `new_task_${taskId}_${Date.now()}`,
                    type: 'new_task',
                    taskId,
                    taskTitle,
                    targetUserRole: 'student',
                    targetUsernames: targetStudents.map(student => student.username),
                    fromUsername: teacherUsername,
                    fromDisplayName: teacherDisplayName,
                    teacherName: teacherDisplayName,
                    course,
                    subject,
                    timestamp: new Date().toISOString(),
                    read: false,
                    readBy: [],
                    taskType
                };

                notifications.push(newNotification);
                console.log('New notification created:', newNotification);
                console.log('Target usernames:', newNotification.targetUsernames);
                console.log('Total notifications after creation:', notifications.length);
                
                this.saveNotifications(notifications);
                console.log('Notifications saved to localStorage');
                
                return newNotification;
            },

            getStudentsInCourse(course) {
                const users = this.getUsers();
                return users
                    .filter(user => 
                        user.role === 'student' && 
                        user.activeCourses && 
                        user.activeCourses.includes(course)
                    )
                    .map(user => ({
                        username: user.username,
                        displayName: user.displayName || user.username
                    }));
            }
        };

        function log(message, type = 'info') {
            console.log(message);
            return `[${new Date().toLocaleTimeString()}] ${message}\n`;
        }

        function paso1_ConfigurarDatos() {
            let resultado = '';
            
            try {
                // Configurar usuarios
                const usuarios = [datosPrueba.profesor, ...datosPrueba.estudiantes];
                NotificationSystem.saveUsers(usuarios);
                resultado += log('‚úÖ Usuarios configurados correctamente');
                resultado += log(`   üë• ${usuarios.length} usuarios guardados`);
                
                // Limpiar notificaciones y tareas anteriores
                NotificationSystem.saveNotifications([]);
                NotificationSystem.saveTasks([]);
                resultado += log('üßπ Datos anteriores limpiados');
                
                // Verificar configuraci√≥n
                const usuariosGuardados = NotificationSystem.getUsers();
                resultado += log(`üìä Verificaci√≥n: ${usuariosGuardados.length} usuarios en localStorage`);
                
                document.getElementById('resultado-paso1').textContent = resultado;
                document.getElementById('resultado-paso1').className = 'result-box success';
                
            } catch (error) {
                resultado += log(`‚ùå Error en configuraci√≥n: ${error.message}`, 'error');
                document.getElementById('resultado-paso1').textContent = resultado;
                document.getElementById('resultado-paso1').className = 'result-box error';
            }
        }

        function paso2_CrearTareaEspecifica() {
            let resultado = '';
            
            try {
                // Crear tarea asignada solo a Felipe
                const taskId = `task_especifica_${Date.now()}`;
                const tareaEspecifica = {
                    id: taskId,
                    title: 'Tarea Solo para Felipe',
                    description: 'Esta tarea est√° asignada √∫nicamente a Felipe',
                    subject: 'Ciencias Naturales',
                    course: datosPrueba.curso,
                    assignedById: datosPrueba.profesor.id,
                    assignedByName: datosPrueba.profesor.displayName,
                    assignedTo: 'student', // üîë CLAVE: Asignaci√≥n espec√≠fica
                    assignedStudentIds: ['est_001'], // üîë CLAVE: Solo Felipe
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    priority: 'medium',
                    attachments: [],
                    taskType: 'tarea'
                };
                
                // Guardar tarea
                const tasks = NotificationSystem.getTasks();
                tasks.push(tareaEspecifica);
                NotificationSystem.saveTasks(tasks);
                
                resultado += log('üìù Tarea espec√≠fica creada');
                resultado += log(`   üìã ID: ${taskId}`);
                resultado += log(`   üéØ Asignada a: ${tareaEspecifica.assignedStudentIds.join(', ')}`);
                resultado += log(`   üìö Tipo asignaci√≥n: ${tareaEspecifica.assignedTo}`);
                
                // Crear notificaci√≥n usando el sistema corregido
                const notificacion = NotificationSystem.createNewTaskNotifications(
                    taskId,
                    tareaEspecifica.title,
                    tareaEspecifica.course,
                    tareaEspecifica.subject,
                    datosPrueba.profesor.username,
                    datosPrueba.profesor.displayName,
                    'assignment'
                );
                
                if (notificacion) {
                    resultado += log('üîî Notificaci√≥n creada exitosamente');
                    resultado += log(`   üéØ Destinatarios: ${notificacion.targetUsernames.join(', ')}`);
                    resultado += log(`   ‚úÖ Solo Felipe deber√≠a recibir la notificaci√≥n`);
                } else {
                    resultado += log('‚ùå No se cre√≥ notificaci√≥n', 'error');
                }
                
                document.getElementById('resultado-paso2').textContent = resultado;
                document.getElementById('resultado-paso2').className = 'result-box success';
                
            } catch (error) {
                resultado += log(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('resultado-paso2').textContent = resultado;
                document.getElementById('resultado-paso2').className = 'result-box error';
            }
        }

        function paso3_CrearTareaCurso() {
            let resultado = '';
            
            try {
                // Crear tarea para todo el curso
                const taskId = `task_curso_${Date.now()}`;
                const tareaCurso = {
                    id: taskId,
                    title: 'Tarea para Todo el Curso',
                    description: 'Esta tarea est√° asignada a todos los estudiantes del curso',
                    subject: 'Ciencias Naturales',
                    course: datosPrueba.curso,
                    assignedById: datosPrueba.profesor.id,
                    assignedByName: datosPrueba.profesor.displayName,
                    assignedTo: 'course', // üîë CLAVE: Asignaci√≥n a curso
                    assignedStudentIds: undefined, // üîë CLAVE: No hay IDs espec√≠ficos
                    dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    status: 'pending',
                    priority: 'medium',
                    attachments: [],
                    taskType: 'tarea'
                };
                
                // Guardar tarea
                const tasks = NotificationSystem.getTasks();
                tasks.push(tareaCurso);
                NotificationSystem.saveTasks(tasks);
                
                resultado += log('üìù Tarea para curso creada');
                resultado += log(`   üìã ID: ${taskId}`);
                resultado += log(`   üìö Tipo asignaci√≥n: ${tareaCurso.assignedTo}`);
                resultado += log(`   üë• Destinatarios: todos los estudiantes del curso`);
                
                // Crear notificaci√≥n usando el sistema corregido
                const notificacion = NotificationSystem.createNewTaskNotifications(
                    taskId,
                    tareaCurso.title,
                    tareaCurso.course,
                    tareaCurso.subject,
                    datosPrueba.profesor.username,
                    datosPrueba.profesor.displayName,
                    'assignment'
                );
                
                if (notificacion) {
                    resultado += log('üîî Notificaci√≥n creada exitosamente');
                    resultado += log(`   üéØ Destinatarios: ${notificacion.targetUsernames.join(', ')}`);
                    resultado += log(`   ‚úÖ Todos los estudiantes deber√≠an recibir la notificaci√≥n`);
                } else {
                    resultado += log('‚ùå No se cre√≥ notificaci√≥n', 'error');
                }
                
                document.getElementById('resultado-paso3').textContent = resultado;
                document.getElementById('resultado-paso3').className = 'result-box success';
                
            } catch (error) {
                resultado += log(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('resultado-paso3').textContent = resultado;
                document.getElementById('resultado-paso3').className = 'result-box error';
            }
        }

        function verificarNotificaciones() {
            let resultado = '';
            
            try {
                const notificaciones = NotificationSystem.getNotifications();
                const tasks = NotificationSystem.getTasks();
                
                resultado += log(`üìä RESUMEN DE VERIFICACI√ìN`);
                resultado += log(`üîî Total notificaciones: ${notificaciones.length}`);
                resultado += log(`üìù Total tareas: ${tasks.length}`);
                resultado += log('');
                
                // An√°lisis por tipo de asignaci√≥n
                const tareaEspecifica = tasks.find(t => t.assignedTo === 'student');
                const tareaCurso = tasks.find(t => t.assignedTo === 'course');
                
                if (tareaEspecifica) {
                    const notifEspecifica = notificaciones.find(n => n.taskId === tareaEspecifica.id);
                    resultado += log('üéØ TAREA ESPEC√çFICA:');
                    resultado += log(`   üìã T√≠tulo: ${tareaEspecifica.title}`);
                    resultado += log(`   üë§ Asignada a ID: ${tareaEspecifica.assignedStudentIds}`);
                    
                    if (notifEspecifica) {
                        resultado += log(`   ‚úÖ Notificaci√≥n encontrada`);
                        resultado += log(`   üéØ Destinatarios: ${notifEspecifica.targetUsernames.join(', ')}`);
                        
                        if (notifEspecifica.targetUsernames.length === 1 && notifEspecifica.targetUsernames[0] === 'felipe_est') {
                            resultado += log(`   ‚úÖ CORRECTO: Solo Felipe recibe la notificaci√≥n`);
                        } else {
                            resultado += log(`   ‚ùå ERROR: Destinatarios incorrectos`);
                        }
                    } else {
                        resultado += log(`   ‚ùå ERROR: No se encontr√≥ notificaci√≥n`);
                    }
                }
                
                resultado += log('');
                
                if (tareaCurso) {
                    const notifCurso = notificaciones.find(n => n.taskId === tareaCurso.id);
                    resultado += log('üìö TAREA DE CURSO:');
                    resultado += log(`   üìã T√≠tulo: ${tareaCurso.title}`);
                    resultado += log(`   üë• Asignada a: todo el curso`);
                    
                    if (notifCurso) {
                        resultado += log(`   ‚úÖ Notificaci√≥n encontrada`);
                        resultado += log(`   üéØ Destinatarios: ${notifCurso.targetUsernames.join(', ')}`);
                        
                        if (notifCurso.targetUsernames.length === 4) {
                            resultado += log(`   ‚úÖ CORRECTO: Todos los estudiantes reciben la notificaci√≥n`);
                        } else {
                            resultado += log(`   ‚ùå ERROR: N√∫mero incorrecto de destinatarios`);
                        }
                    } else {
                        resultado += log(`   ‚ùå ERROR: No se encontr√≥ notificaci√≥n`);
                    }
                }
                
                document.getElementById('resultado-verificacion').textContent = resultado;
                document.getElementById('resultado-verificacion').className = 'result-box info';
                
                // Mostrar panel de resultados detallado
                mostrarPanelResultados(notificaciones, tasks);
                
                // Simular panel de notificaciones
                simularPanelNotificaciones(notificaciones);
                
            } catch (error) {
                resultado += log(`‚ùå Error en verificaci√≥n: ${error.message}`, 'error');
                document.getElementById('resultado-verificacion').textContent = resultado;
                document.getElementById('resultado-verificacion').className = 'result-box error';
            }
        }

        function mostrarPanelResultados(notificaciones, tasks) {
            const panel = document.getElementById('panel-resultados');
            
            let html = '<table class="comparison-table">';
            html += '<thead><tr><th>Tarea</th><th>Tipo Asignaci√≥n</th><th>Estudiantes Objetivo</th><th>Notificaci√≥n Creada</th><th>Destinatarios</th><th>Estado</th></tr></thead>';
            html += '<tbody>';
            
            tasks.forEach(task => {
                const notif = notificaciones.find(n => n.taskId === task.id);
                const esEspecifica = task.assignedTo === 'student';
                const destinatariosEsperados = esEspecifica ? 
                    (task.assignedStudentIds ? task.assignedStudentIds.length : 0) : 
                    datosPrueba.estudiantes.length;
                
                html += '<tr>';
                html += `<td><strong>${task.title}</strong></td>`;
                html += `<td><span class="badge">${task.assignedTo}</span></td>`;
                html += `<td>${destinatariosEsperados} estudiante(s)</td>`;
                html += `<td>${notif ? '‚úÖ S√≠' : '‚ùå No'}</td>`;
                html += `<td>${notif ? notif.targetUsernames.join(', ') : 'N/A'}</td>`;
                
                let estado = '';
                if (!notif) {
                    estado = '<span style="color: red;">‚ùå Sin notificaci√≥n</span>';
                } else if (notif.targetUsernames.length === destinatariosEsperados) {
                    estado = '<span style="color: green;">‚úÖ Correcto</span>';
                } else {
                    estado = '<span style="color: orange;">‚ö†Ô∏è Destinatarios incorrectos</span>';
                }
                html += `<td>${estado}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            panel.innerHTML = html;
        }

        function simularPanelNotificaciones(notificaciones) {
            const panel = document.getElementById('simulacion-panel');
            
            if (notificaciones.length === 0) {
                panel.innerHTML = '<p>No hay notificaciones para mostrar.</p>';
                return;
            }
            
            let html = '<h4>üì± Vista desde diferentes estudiantes:</h4>';
            
            datosPrueba.estudiantes.forEach(estudiante => {
                const notificacionesEstudiante = notificaciones.filter(n => 
                    n.targetUsernames.includes(estudiante.username)
                );
                
                html += `<div class="notification-item ${notificacionesEstudiante.length > 0 ? 'student-specific' : 'course-wide'}">`;
                html += `<div class="notification-header">üë§ ${estudiante.displayName} (${estudiante.username})</div>`;
                
                if (notificacionesEstudiante.length > 0) {
                    html += `<div>üîî ${notificacionesEstudiante.length} notificaci√≥n(es):</div>`;
                    notificacionesEstudiante.forEach(notif => {
                        html += `<div class="notification-details">`;
                        html += `üìã ${notif.taskTitle} (${notif.taskType})<br>`;
                        html += `üë®‚Äçüè´ De: ${notif.fromDisplayName}<br>`;
                        html += `üìö Curso: ${notif.course}`;
                        html += `</div>`;
                    });
                } else {
                    html += `<div>üì≠ Sin notificaciones</div>`;
                }
                
                html += '</div>';
            });
            
            panel.innerHTML = html;
        }

        // Ejecutar configuraci√≥n inicial al cargar la p√°gina
        window.addEventListener('load', function() {
            console.log('üß™ Sistema de prueba de asignaciones espec√≠ficas cargado');
        });
    </script>
</body>
</html>
